{% extends 'advisor_app/base.html' %}
{% load i18n %}

{% block content %}
<div class="hero-section rounded-2">
    <div class="container text-center">
        <h1 class="display-4">{% trans "AI-Powered Agricultural Advisor" %}</h1>
        <p class="lead">{% trans "Get real-time farming advice based on weather, soil conditions, and agricultural research" %}</p>
        <a href="#features" class="btn btn-light btn-lg mt-3 rounded-2">
            <i class="fas fa-arrow-down me-2"></i>{% trans "Explore Features" %}
        </a>
    </div>
</div>

<!-- Features Section -->
<section id="features" class="py-5 bg-white rounded-2">
    <div class="container">
        <div class="row text-center mb-5">
            <div class="col-12">
                <h2 class="display-5 fw-bold text-dark">{% trans "Why Choose Our AI Advisor?" %}</h2>
                <p class="lead text-muted">{% trans "Advanced technology meets agricultural expertise" %}</p>
            </div>
        </div>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm rounded">
                    <div class="card-body text-center p-4">
                        <div class="feature-icon mb-3">
                            <i class="fas fa-cloud-sun fa-3x text-primary"></i>
                        </div>
                        <h5 class="card-title fw-bold">{% trans "Weather Integration" %}</h5>
                        <p class="card-text text-muted">{% trans "Real-time weather forecasts and historical data analysis for precise farming decisions." %}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm rounded">
                    <div class="card-body text-center p-4">
                        <div class="feature-icon mb-3">
                            <i class="fas fa-brain fa-3x text-success"></i>
                        </div>
                        <h5 class="card-title fw-bold">{% trans "AI-Powered Insights" %}</h5>
                        <p class="card-text text-muted">{% trans "Advanced machine learning algorithms provide personalized agricultural recommendations." %}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm rounded">
                    <div class="card-body text-center p-4">
                        <div class="feature-icon mb-3">
                            <i class="fas fa-globe fa-3x text-info"></i>
                        </div>
                        <h5 class="card-title fw-bold">{% trans "Global Coverage" %}</h5>
                        <p class="card-text text-muted">{% trans "Support for multiple languages and regions worldwide." %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Stats Section -->
<section class="py-5 bg-light rounded-2">
    <div class="container">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="stat-item">
                    <h3 class="display-4 fw-bold text-primary">10K+</h3>
                    <p class="text-muted">{% trans "Farmers Helped" %}</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <h3 class="display-4 fw-bold text-success">50+</h3>
                    <p class="text-muted">{% trans "Crop Types" %}</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <h3 class="display-4 fw-bold text-info">200+</h3>
                    <p class="text-muted">{% trans "Countries" %}</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <h3 class="display-4 fw-bold text-warning">24/7</h3>
                    <p class="text-muted">{% trans "AI Availability" %}</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Advisor Form Section -->
<section class="py-5 rounded-2">
    <div class="container-fluid px-4">
        <div class="row justify-content-center">
            <div class="col-xl-10 col-lg-11">
                <div class="text-center mb-5">
                    <h2 class="display-5 fw-bold">{% trans "Get Your Agricultural Advice" %}</h2>
                    <p class="lead text-muted">{% trans "Ask our AI advisor any farming-related question" %}</p>
                </div>
                <!-- Initial Query Form -->
                <div class="query-form" id="initialForm">
                    <form id="agriculturalForm">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="id_location" class="form-label fw-semibold">
                                <i class="fas fa-map-marker-alt me-2 text-primary"></i>{% trans "Your Location" %}
                            </label>
                            {{ form.location }}
                        </div>

                        <div class="mb-3">
                            <label for="id_crop_type" class="form-label fw-semibold">
                                <i class="fas fa-seedling me-2 text-success"></i>{% trans "Crop Type" %}
                            </label>
                            {{ form.crop_type }}
                        </div>

                        <div class="mb-3">
                            <label for="id_language" class="form-label fw-semibold">
                                <i class="fas fa-language me-2 text-info"></i>{% trans "Response Language" %}
                            </label>
                            {{ form.language }}
                        </div>

                        <div class="mb-3">
                            <label for="id_query" class="form-label fw-semibold">
                                <i class="fas fa-question-circle me-2 text-warning"></i>{% trans "Your Agricultural Question" %}
                            </label>
                            {{ form.query }}
                        </div>

                        <button type="submit" class="btn btn-success btn-lg w-100">
                            <i class="fas fa-robot me-2"></i>{% trans "Get AI Advice" %}
                        </button>
                    </form>
                </div>

                <!-- Follow-up Query Form (shown after first interaction) -->
                <div class="followup-form d-none" id="followupForm">
                    <div class="card border-success">
                        <div class="card-body">
                            <h6 class="card-title text-success mb-3">
                                <i class="fas fa-comments me-2"></i>{% trans "Continue the Conversation" %}
                            </h6>
                            <form id="followupFormElement">
                                {% csrf_token %}
                                <div class="input-group mb-3">
                                    <input type="text" id="followupQuery" class="form-control form-control-lg"
                                           placeholder="{% trans 'Ask a follow-up question...' %}" required>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>{% trans "AI remembers our conversation context" %}
                                    </small>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="newConversationBtn">
                                        <i class="fas fa-plus me-1"></i>{% trans "New Conversation" %}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="loading text-center mt-4" id="loading">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">{% trans "Loading..." %}</span>
                    </div>
                    <p class="mt-3 fw-semibold text-muted">{% trans "Analyzing your query and gathering agricultural data..." %}</p>
                </div>

                <div class="response-section" id="responseSection" style="display: none;">
                    <h5 class="mb-4 text-center fw-bold">
                        <i class="fas fa-comments text-primary me-2"></i>{% trans "Conversation with AI Advisor" %}
                    </h5>
                    <div id="chatHistory" class="chat-history mb-3" style="max-height: 400px; overflow-y: auto;">
                        <!-- Chat messages will be appended here -->
                    </div>
                    <div id="responseContent" class="d-none">
                        <!-- Hidden container for backward compatibility -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Testimonials Section -->
<section class="py-5 bg-white rounded-2">
    <div class="container">
        <div class="row text-center mb-5">
            <div class="col-12">
                <h2 class="display-5 fw-bold text-dark">{% trans "What Farmers Say" %}</h2>
                <p class="lead text-muted">{% trans "Real feedback from our community" %}</p>
            </div>
        </div>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm rounded">
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <i class="fas fa-quote-left fa-2x text-muted"></i>
                        </div>
                        <p class="card-text text-muted mb-3">"{% trans "The AI advisor helped me increase my crop yield by 30% with precise irrigation recommendations." %}"</p>
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <span class="text-white fw-bold">J</span>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0 fw-bold">{% trans "John Smith" %}</h6>
                                <small class="text-muted">{% trans "Wheat Farmer, USA" %}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm rounded">
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <i class="fas fa-quote-left fa-2x text-muted"></i>
                        </div>
                        <p class="card-text text-muted mb-3">"{% trans "Weather predictions saved my crops from frost damage. Highly recommend!" %}"</p>
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <span class="text-white fw-bold">M</span>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0 fw-bold">{% trans "Maria Garcia" %}</h6>
                                <small class="text-muted">{% trans "Vineyard Owner, Spain" %}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm rounded">
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <i class="fas fa-quote-left fa-2x text-muted"></i>
                        </div>
                        <p class="card-text text-muted mb-3">"{% trans "The multilingual support helped me understand farming techniques from around the world." %}"</p>
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-info rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <span class="text-white fw-bold">A</span>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0 fw-bold">{% trans "Ahmed Hassan" %}</h6>
                                <small class="text-muted">{% trans "Rice Farmer, Egypt" %}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Function to add message to chat history
function addMessageToChat(role, content, timestamp) {
    const chatHistory = document.getElementById('chatHistory');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}-message mb-3`;

    const messageContent = document.createElement('div');
    messageContent.className = role === 'user' ? 'bg-primary text-white p-3 rounded' : 'bg-light p-3 rounded border';
    messageContent.innerHTML = content.replace(/\n/g, '<br>');

    const timestampDiv = document.createElement('small');
    timestampDiv.className = 'text-muted';
    timestampDiv.textContent = timestamp ? new Date(timestamp).toLocaleTimeString() : '';

    messageDiv.appendChild(messageContent);
    if (timestamp) messageDiv.appendChild(timestampDiv);

    chatHistory.appendChild(messageDiv);
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

// Function to load conversation history from session
function loadConversationHistory() {
    fetch('{% url "advisor_app:get_conversation_history" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.history && data.history.length > 0) {
            document.getElementById('responseSection').style.display = 'block';
            data.history.forEach(msg => {
                addMessageToChat(msg.role, msg.content, msg.timestamp);
            });
        }
    })
    .catch(error => {
        console.log('No existing conversation history');
    });
}

document.getElementById('agriculturalForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const userQuery = document.getElementById('id_query').value;
    const data = {
        'query': userQuery,
        'location': document.getElementById('id_location').value,
        'crop_type': document.getElementById('id_crop_type').value,
        'language': document.getElementById('id_language').value,
        'csrfmiddlewaretoken': formData.get('csrfmiddlewaretoken'),
        'timestamp': new Date().toISOString()
    };

    // Add user message to chat immediately
    addMessageToChat('user', userQuery, data.timestamp);

    // Clear the query input
    document.getElementById('id_query').value = '';

    // Show loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('responseSection').style.display = 'block';

    fetch('{% url "advisor_app:get_advice" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': data.csrfmiddlewaretoken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loading').style.display = 'none';

        if (data.success) {
            // Add AI response to chat
            addMessageToChat('assistant', data.response, new Date().toISOString());

            // Switch to follow-up form after first interaction
            document.getElementById('initialForm').classList.add('d-none');
            document.getElementById('followupForm').classList.remove('d-none');
        } else {
            addMessageToChat('assistant', 'Error: ' + data.error, new Date().toISOString());
        }
    })
    .catch(error => {
        document.getElementById('loading').style.display = 'none';
        addMessageToChat('assistant', 'Error: ' + error.message, new Date().toISOString());
    });
});

// Handle follow-up form submission
document.getElementById('followupFormElement').addEventListener('submit', function(e) {
    e.preventDefault();

    const followupQuery = document.getElementById('followupQuery').value;
    const data = {
        'query': followupQuery,
        'location': '', // Use empty for follow-ups, AI will remember from context
        'crop_type': '',
        'language': 'en', // Default to English for follow-ups
        'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'timestamp': new Date().toISOString()
    };

    // Add user message to chat immediately
    addMessageToChat('user', followupQuery, data.timestamp);

    // Clear the follow-up input
    document.getElementById('followupQuery').value = '';

    // Show loading
    document.getElementById('loading').style.display = 'block';

    fetch('{% url "advisor_app:get_advice" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': data.csrfmiddlewaretoken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loading').style.display = 'none';

        if (data.success) {
            // Add AI response to chat
            addMessageToChat('assistant', data.response, new Date().toISOString());
        } else {
            addMessageToChat('assistant', 'Error: ' + data.error, new Date().toISOString());
        }
    })
    .catch(error => {
        document.getElementById('loading').style.display = 'none';
        addMessageToChat('assistant', 'Error: ' + error.message, new Date().toISOString());
    });
});

// Handle new conversation button
document.getElementById('newConversationBtn').addEventListener('click', function() {
    // Clear conversation history from session
    fetch('{% url "advisor_app:clear_conversation" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(() => {
        // Clear chat history UI
        document.getElementById('chatHistory').innerHTML = '';
        document.getElementById('responseSection').style.display = 'none';

        // Switch back to initial form
        document.getElementById('initialForm').classList.remove('d-none');
        document.getElementById('followupForm').classList.add('d-none');
    })
    .catch(error => {
        console.log('Error clearing conversation:', error);
    });
});

// Load conversation history on page load
document.addEventListener('DOMContentLoaded', loadConversationHistory);
</script>
{% endblock %}
